<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>3D BMW M4 Bilspill</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: Arial, sans-serif;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #fff;
            z-index: 10;
            font-size: 18px;
        }
    </style>
</head>
<body>
<div id="info">Styr bilen med piltastene ← ↑ → ↓</div>

<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>

<script>
// SCENE
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x202030);

// KAMERA
const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);

// RENDERER
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled = true;
document.body.appendChild(renderer.domElement);

// LYS
const ambient = new THREE.AmbientLight(0xffffff, 0.4);
scene.add(ambient);

const sun = new THREE.DirectionalLight(0xffffff, 1);
sun.position.set(100, 200, 100);
sun.castShadow = true;
scene.add(sun);

// BAKKE
const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(2000, 2000),
    new THREE.MeshPhongMaterial({ color: 0x404040 })
);
ground.rotation.x = -Math.PI / 2;
ground.receiveShadow = true;
scene.add(ground);

// BYGNINGER
function addBuilding(x, z, w, h, d) {
    const b = new THREE.Mesh(
        new THREE.BoxGeometry(w, h, d),
        new THREE.MeshPhongMaterial({ color: 0x223355 })
    );
    b.position.set(x, h / 2, z);
    b.castShadow = true;
    b.receiveShadow = true;
    scene.add(b);
}

addBuilding(-200, -200, 80, 120, 80);
addBuilding(200, -150, 100, 150, 100);
addBuilding(-150, 200, 120, 100, 120);
addBuilding(150, 250, 140, 160, 140);

// BMW‑AKTIG BIL
const car = new THREE.Group();

// Karosseri
const body = new THREE.Mesh(
    new THREE.BoxGeometry(6, 1.2, 3),
    new THREE.MeshPhongMaterial({ color: 0x0077ff, shininess: 200 })
);
body.castShadow = true;
car.add(body);

// Tak
const cabin = new THREE.Mesh(
    new THREE.BoxGeometry(3.2, 0.7, 2.4),
    new THREE.MeshPhongMaterial({ color: 0xffffff, opacity: 0.7, transparent: true })
);
cabin.position.set(0, 1.0, -0.2);
cabin.castShadow = true;
car.add(cabin);

// HJUL
function createWheel() {
    const w = new THREE.Mesh(
        new THREE.CylinderGeometry(0.6, 0.6, 0.5, 20),
        new THREE.MeshPhongMaterial({ color: 0x111111 })
    );
    w.rotation.z = Math.PI / 2;
    w.castShadow = true;
    return w;
}

const wheelFL = createWheel();
const wheelFR = createWheel();
const wheelBL = createWheel();
const wheelBR = createWheel();

wheelFL.position.set(-2, -0.1, 1.4);
wheelFR.position.set(2, -0.1, 1.4);
wheelBL.position.set(-2, -0.1, -1.4);
wheelBR.position.set(2, -0.1, -1.4);

car.add(wheelFL, wheelFR, wheelBL, wheelBR);

car.position.set(0, 1, 0);
scene.add(car);

// INPUT
const keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false };
document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

// BILFYSIKK
let speed = 0;
const maxSpeed = 2.5;
const accel = 0.06;
const friction = 0.02;
const turnSpeed = 0.04;

function updateCar() {
    // Akselerasjon
    if (keys.ArrowUp) speed += accel;
    if (keys.ArrowDown) speed -= accel;

    // Begrens fart
    speed = Math.max(Math.min(speed, maxSpeed), -maxSpeed / 2);

    // Friksjon
    if (!keys.ArrowUp && !keys.ArrowDown) {
        if (speed > 0) speed -= friction;
        if (speed < 0) speed += friction;
        if (Math.abs(speed) < 0.01) speed = 0;
    }

    // Svinging
    if (speed !== 0) {
        if (keys.ArrowLeft) car.rotation.y += turnSpeed * (speed / maxSpeed);
        if (keys.ArrowRight) car.rotation.y -= turnSpeed * (speed / maxSpeed);
    }

    // Bevegelse (ingen sidelengs glidning)
    const forward = new THREE.Vector3();
    car.getWorldDirection(forward);
    car.position.addScaledVector(forward, speed);

    // Hjulrotasjon
    const wheelSpin = speed * 5;
    wheelFL.rotation.x -= wheelSpin;
    wheelFR.rotation.x -= wheelSpin;
    wheelBL.rotation.x -= wheelSpin;
    wheelBR.rotation.x -= wheelSpin;
}

// KAMERA
function updateCamera() {
    const offset = new THREE.Vector3(0, 5, 12);
    offset.applyAxisAngle(new THREE.Vector3(0, 1, 0), car.rotation.y);

    const camPos = car.position.clone().add(offset);
    camera.position.lerp(camPos, 0.1);
    camera.lookAt(car.position.clone().add(new THREE.Vector3(0, 1, 0)));
}

// LOOP
function animate() {
    requestAnimationFrame(animate);
    updateCar();
    updateCamera();
    renderer.render(scene, camera);
}

animate();

// Resize
window.addEventListener("resize", () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>

</body>
</html>
